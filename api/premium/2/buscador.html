<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <style>
        /* Estilos existentes */
        .tabs .tab a:focus,
        .tabs .tab a:focus.active { background: none; }
        .col img { aspect-ratio: 2 / 3; width: 100%; border-radius: 5px; margin-bottom: 5px; }
        .padDrew { padding: 10px 0; margin: 0; }
        .sidenav li { transition: background ease .2s; }
        .row .col { padding: 0 5px; }
        .each-category { padding: 0 5px; }
        .sidenav li > a { margin: 0 10px; background: #212121; color: rgb(222,215,215); border-radius: 3px; display: flex; align-items: center; gap: 10px; padding: 0 10px; }
        #nav-mobile a.active-sidenav,
        .sidenav li > a.active-sidenav { background: rgba(60,128,85,.2); color: #20bf6b; }
        #nav-mobile a { font-weight: 600; }
        .buscador { float: right; margin: 0 18px; z-index: 1; }
        @media screen and (min-width: 991px) { nav .brand-logo { margin: 0 10px; } }
        @media only screen and (max-width: 992px) { nav .brand-logo { left: 150px; } }
        .tab a, .sidenav li a { font-weight: 600; }
        img.circle { border-radius: 100%; overflow: hidden; }
        .banner { display: flex; gap: 10px; padding: 10px; background: rgb(20,20,20); }
        .sidenav li { line-height: 0; }
        input[type="text"] { padding: 10px; }
        input[type=text]:not(.browser-default):focus:not([readonly]) { border-bottom: 1px solid #20bf6b; box-shadow: 0 1px 0 0 #20bf6b; }
        .container-x { width: 90%; margin: 0 auto; }
        #busquedas span { display: none; }
        .animation { opacity: 1; animation: fade 2s ease; }
        @keyframes fade { 0% { opacity: 0; } 100% { opacity: 1; }}
    </style>
    <title>Buscador - Api</title>
</head>
<body class="grey darken-4">
    <div class="navbar-fixed">
        <nav>
            <div class="nav-wrapper black">
                <div class="container-x">
                    <div class="input-field col s6">
                        <input placeholder="Buscar..." type="text" class="white-text" id="buscar" onkeyup="myFunction()">
                    </div>
                </div>
            </div>
        </nav>
    </div>

    <!-- Contenedor de mensajes -->
    <div id="messageContainer" style="display:none; background: #20bf6b; color: white; padding: 10px; position: fixed; top: 10px; right: 10px; z-index: 1000; border-radius: 5px;">
        <span id="messageText"></span>
    </div>

    <ul id="busquedas" class="row padDrew" style="display:none;"></ul>

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://tv-vivo.github.io/live/api/premium.js"></script>
    <script src="https://tv-vivo.github.io/live/api/config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = getQueryParams();
            const user = params.usuario;
            const key = params.key;
            checkCredentials(user, key);
        });

        function getQueryParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const queryArray = queryString.split('&');
            queryArray.forEach(param => {
                const [key, value] = param.split('=');
                params[decodeURIComponent(key)] = decodeURIComponent(value);
            });
            return params;
        }

        function checkCredentials(user, key) {
            const today = new Date();
            if (!user || !key) {
                showMessage('Faltan parámetros: usuario y/o key.');
                return;
            }

            const userObj = usuarios.find(u => u.user === user && u.key === key);
            if (userObj) {
                const { dia, mes, year } = userObj.fechaVencimiento;
                const expiryDate = new Date(year, mes - 1, dia);
                const currentDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                if (currentDate > expiryDate) {
                    showMessage('El usuario ha vencido.');
                    hideSearch();
                } else {
                    document.getElementById('busquedas').style.display = 'block';
                    displayMovies(movies);
                }
            } else {
                showMessage('Verifica el usuario y la contraseña.');
                hideSearch();
            }
        }

        function showMessage(message) {
            const messageContainer = document.getElementById('messageContainer');
            const messageText = document.getElementById('messageText');
            
            messageText.textContent = message;
            messageContainer.style.display = 'block';

            // Desaparecer el mensaje después de 3 segundos
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 3000);
        }

        function hideSearch() {
            document.getElementById('busquedas').style.display = 'none';
        }

        function displayMovies(movies) {
            const ul = document.getElementById('busquedas');
            ul.innerHTML = ''; // Limpiar la lista
            movies.forEach(movie => {
                const params = getQueryParams()
                const user = params.usuario
                const key = params.key
                const li = document.createElement('li');
                const url = `https://vpnmovie.onrender.com/api/movie?imb=${movie.imb}&usuario=${user}&key=${key}`
                li.innerHTML = `
                    <a href="${url}" class="col s4 m3 l2">
                        <img src="${movie.img}" alt="${movie.titulo}">
                        <span>${movie.titulo}</span>
                    </a>
                `;
                ul.appendChild(li);
            });
        }

        function myFunction() {
            const input = document.getElementById('buscar');
            const filter = input.value.toLowerCase();
            const ul = document.getElementById('busquedas');
            const li = ul.getElementsByTagName('li');

            for (let i = 0; i < li.length; i++) {
                const a = li[i].getElementsByTagName("a")[0];
                if (a.innerHTML.toLowerCase().indexOf(filter) > -1) {
                    li[i].style.display = "";
                } else {
                    li[i].style.display = "none";
                }
            }
        }
    </script>
</body></html>
